// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Optional - only needed for migrations
}

// Profile table - Links to Supabase auth.users
// userId field connects to Supabase auth.users.id
model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique // Links to Supabase auth.users.id
  email     String   @unique
  fullName  String?
  avatarUrl String?
  role      UserRole @default(CONSUMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templates Template[]

  @@map("profiles")
}

enum UserRole {
  CONSUMER
  CREATOR
  ADMIN
}

// Template model - Core marketplace asset
model Template {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  price       Decimal  @default(0) @db.Decimal(10, 2)
  currency    String   @default("USD")
  category    String
  toolStack   String[] // Array: ["n8n", "OpenAI", "Gmail"]
  complexity  Complexity @default(MEDIUM)
  status      TemplateStatus @default(PENDING)
  
  // Vector embedding for semantic search (pgvector)
  // Note: Prisma doesn't natively support vector type, 
  // so we'll store as Unsupported type or use raw SQL for vector operations
  embedding   Unsupported("vector(1536)")?
  
  // Metadata
  views       Int      @default(0)
  downloads   Int      @default(0)
  likes       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  creatorId   String
  creator     Profile  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  versions    TemplateVersion[]
  interactions Interaction[]

  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([creatorId])
  @@map("templates")
}

enum Complexity {
  LOW
  MEDIUM
  HIGH
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

// Template versions - Version control for templates
model TemplateVersion {
  id            String   @id @default(uuid())
  templateId    String
  template      Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  versionNumber String   // e.g., "1.0", "1.1"
  fileUrl       String   // Link to Supabase Storage
  changelog     String?  @db.Text
  createdAt     DateTime @default(now())

  @@unique([templateId, versionNumber])
  @@index([templateId])
  @@map("template_versions")
}

// User interactions - Views, downloads, likes
model Interaction {
  id         String   @id @default(uuid())
  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  userId     String?  // Nullable for anonymous interactions (links to Supabase auth.users.id)
  type       InteractionType
  createdAt  DateTime @default(now())

  @@unique([templateId, userId, type])
  @@index([templateId])
  @@index([userId])
  @@map("interactions")
}

enum InteractionType {
  VIEW
  DOWNLOAD
  LIKE
}

